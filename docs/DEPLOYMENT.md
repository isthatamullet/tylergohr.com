# Tyler Gohr Portfolio - Deployment Guide

## üöÄ CI/CD Pipeline Overview

This portfolio uses a sophisticated GitHub Actions CI/CD pipeline for automated testing, building, and deployment to Google Cloud Run. The pipeline ensures code quality, security, and performance before any deployment.

## üìã Pipeline Architecture

### PR Validation Workflow (`ci.yml`)
- **Code Quality**: TypeScript checking, ESLint, Prettier formatting
- **Security**: Dependency audit, license compliance checking
- **Build Validation**: Bundle size analysis, Docker image building
- **Testing**: Unit tests, component tests, accessibility validation
- **Performance**: Lighthouse CI integration with budget enforcement
- **Docker Security**: Container vulnerability scanning, structure testing

### Deployment Workflow (`deploy.yml`)
- **Pre-deployment Validation**: Quality gates, version generation
- **Container Build**: Multi-stage Docker build with Google Container Registry
- **Cloud Run Deployment**: Automated deployment with health checks
- **Traffic Migration**: Gradual traffic shifting (10% ‚Üí 50% ‚Üí 100%)
- **Health Monitoring**: Comprehensive health checks and performance validation
- **Rollback Capability**: Automatic rollback on deployment failures

## üîê Required GitHub Secrets

### Essential Secrets

#### `GCP_PROJECT_ID`
- **Description**: Google Cloud Project ID for deployment
- **Example**: `tylergohr-portfolio`
- **Usage**: Identifies the GCP project for Cloud Run deployment

#### `GCP_SA_KEY`
- **Description**: Google Cloud Service Account key (JSON, base64 encoded)
- **Setup**: Generated by `scripts/setup-gcp-service-account.sh`
- **Format**: Base64 encoded JSON service account key
- **Permissions**: Cloud Run Admin, Storage Admin, Cloud Build Builder

### Optional Enhancement Secrets

#### `LHCI_GITHUB_APP_TOKEN`
- **Description**: Lighthouse CI GitHub App token for performance reporting
- **Usage**: Enhanced Lighthouse reporting with PR comments
- **Setup**: Install Lighthouse CI GitHub App and generate token

## üõ†Ô∏è Setup Instructions

### Step 1: Google Cloud Setup

1. **Create Google Cloud Project**
   ```bash
   gcloud projects create tylergohr-portfolio
   gcloud config set project tylergohr-portfolio
   ```

2. **Run Service Account Setup**
   ```bash
   chmod +x scripts/setup-gcp-service-account.sh
   ./scripts/setup-gcp-service-account.sh tylergohr-portfolio
   ```

3. **Enable Billing** (Required for Cloud Run)
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - Enable billing for the project

### Step 2: GitHub Secrets Configuration

1. **Navigate to Repository Secrets**
   - Go to: `https://github.com/isthatamullet/tylergohr.com/settings/secrets/actions`

2. **Add Required Secrets**
   ```
   Name: GCP_PROJECT_ID
   Value: tylergohr-portfolio
   
   Name: GCP_SA_KEY
   Value: [Base64 encoded service account JSON key]
   ```

3. **Verify Service Account Key Format**
   ```bash
   # The key should be base64 encoded:
   cat github-actions-sa-key.json | base64 -w 0
   ```

### Step 3: Environment Configuration

1. **Production Environment**
   - Environment: `production`
   - Branch: `main`
   - URL: Will be provided after first deployment

2. **Staging Environment** (Optional)
   - Environment: `staging`
   - Branch: `develop`
   - URL: Separate Cloud Run service for testing

## üîÑ Deployment Process

### Automatic Deployment (Main Branch)
1. Push to `main` branch triggers deployment workflow
2. Pre-deployment validation runs (typecheck, lint, build)
3. Docker container is built and pushed to GCR
4. Application is deployed to Cloud Run with 0% traffic
5. Health checks validate the new deployment
6. Traffic is gradually migrated (10% ‚Üí 50% ‚Üí 100%)
7. Old revisions are cleaned up (keeps 5 most recent)

### Manual Deployment
```bash
# Trigger manual deployment via GitHub UI
# Go to: Actions ‚Üí Deploy - Production Pipeline ‚Üí Run workflow
# Select environment: staging | production
# Optional: Force deployment (skips some health checks)
```

### Pull Request Validation
1. Create PR targeting `main` branch
2. CI pipeline runs automatically with comprehensive checks
3. PR status checks must pass before merging
4. Lighthouse performance budgets are enforced

## üìä Performance Budgets

### Lighthouse Thresholds
- **Performance**: ‚â• 90
- **Accessibility**: ‚â• 90
- **Best Practices**: ‚â• 90
- **SEO**: ‚â• 90

### Core Web Vitals
- **First Contentful Paint**: ‚â§ 2.5s
- **Largest Contentful Paint**: ‚â§ 2.5s
- **Time to Interactive**: ‚â§ 3.5s
- **Cumulative Layout Shift**: ‚â§ 0.1

### Bundle Size Budget
- **Maximum Bundle Size**: 150KB
- **Build Time Budget**: 5 minutes
- **Container Image Size**: Target < 200MB

## üîç Monitoring and Health Checks

### Health Check Endpoint
- **URL**: `/api/health`
- **Method**: `GET` or `HEAD`
- **Response**: JSON with system status, memory usage, uptime
- **Thresholds**: Memory warning at 400MB, error at 900MB

### Cloud Run Health Checks
- **Startup Probe**: 40s grace period, 30s interval
- **Liveness Probe**: 30s interval, 3s timeout, 3 retries
- **Traffic Requirements**: Health check must pass before traffic allocation

### Performance Monitoring
- **Response Time**: < 3s target for deployment validation
- **Memory Usage**: Monitored and reported in health checks
- **Error Rates**: Tracked through Cloud Run metrics

## üö® Troubleshooting

### Common Issues

#### Service Account Permissions
```bash
# Verify service account has required roles
gcloud projects get-iam-policy tylergohr-portfolio \
  --flatten="bindings[].members" \
  --filter="bindings.members:github-actions-deploy@tylergohr-portfolio.iam.gserviceaccount.com"
```

#### Docker Build Failures
```bash
# Test Docker build locally
docker build -t portfolio-test .
docker run -p 3000:3000 portfolio-test

# Check health endpoint
curl http://localhost:3000/api/health
```

#### Cloud Run Deployment Issues
```bash
# Check Cloud Run service logs
gcloud run services logs read tylergohr-portfolio --region=us-central1

# Verify service configuration
gcloud run services describe tylergohr-portfolio --region=us-central1
```

#### GitHub Actions Failures
1. Check workflow logs in GitHub Actions tab
2. Verify all required secrets are set
3. Ensure service account has proper permissions
4. Check Google Cloud quotas and billing

### Emergency Rollback

#### Automatic Rollback
- Pipeline automatically rolls back on health check failures
- Previous stable revision receives 100% traffic
- Rollback verification ensures service stability

#### Manual Rollback
```bash
# List available revisions
gcloud run revisions list --service=tylergohr-portfolio --region=us-central1

# Rollback to specific revision
gcloud run services update-traffic tylergohr-portfolio \
  --region=us-central1 \
  --to-revisions=REVISION_NAME=100
```

## üéØ Performance Optimization

### Container Optimization
- **Multi-stage Docker build**: Minimizes final image size
- **Alpine Linux base**: Security and size benefits
- **Standalone Next.js output**: Optimized for containerization
- **Non-root user**: Enhanced security posture

### Cloud Run Configuration
- **Memory**: 2GB for optimal performance
- **CPU**: 1 vCPU with automatic scaling
- **Concurrency**: 100 requests per instance
- **Scaling**: 0-10 instances based on demand
- **Timeout**: 300s for complex operations

### Caching Strategy
- **Docker Layer Caching**: GitHub Actions cache for faster builds
- **NPM Dependencies**: Cached between workflow runs
- **Static Assets**: Aggressive caching with proper headers
- **CDN Integration**: Future enhancement for global distribution

## üìà Metrics and Analytics

### Deployment Metrics
- **Build Time**: Tracked and reported in workflows
- **Deployment Duration**: End-to-end pipeline timing
- **Success Rate**: Deployment success/failure tracking
- **Rollback Frequency**: Monitoring deployment stability

### Application Metrics
- **Response Times**: Monitored during health checks
- **Memory Usage**: Tracked in health endpoint
- **Error Rates**: Cloud Run built-in monitoring
- **Traffic Patterns**: Cloud Run analytics

## üîÆ Future Enhancements

### Planned Improvements
- **Multi-region Deployment**: Global availability
- **Blue-Green Deployment**: Zero-downtime deployments
- **Canary Releases**: Advanced traffic splitting
- **Enhanced Monitoring**: Prometheus/Grafana integration
- **Security Scanning**: Advanced vulnerability detection
- **Performance Regression Detection**: Automated performance monitoring

### Integration Opportunities
- **Slack Notifications**: Deployment status updates
- **PagerDuty Integration**: Incident management
- **Datadog Monitoring**: Advanced APM
- **Sentry Error Tracking**: Production error monitoring

---

This deployment pipeline represents enterprise-grade DevOps practices, demonstrating expertise in automation, security, and reliability. The gradual traffic migration and comprehensive health checks ensure zero-downtime deployments while maintaining high availability and performance standards.